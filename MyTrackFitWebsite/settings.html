<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Fit - Settings</title>
    <style>
        /* Base styles from the previous CSS */
        body {
            background: #0f1928;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s; /* Smooth theme transition */
        }
        body.light-mode {
            background: #e0e0e0;
            color: #333;
        }
        body.light-mode .section {
            background: #f0f0f0;
            color: #333;
        }
        body.light-mode h1, body.light-mode h2, body.light-mode .section-title {
            color: #007bff; /* A lighter blue for light mode */
        }
        body.light-mode .setting-item {
            border-bottom-color: #d0d0d0;
        }
        body.light-mode input[type="number"],
        body.light-mode input[type="text"],
        body.light-mode input[type="password"] {
            background: #ffffff;
            border-color: #a0a0a0;
            color: #333;
        }
        body.light-mode input[type="checkbox"] {
            border-color: #a0a0a0;
        }
        body.light-mode input[type="checkbox"]:checked {
            background-color: #007bff;
            border-color: #007bff;
        }
        body.light-mode input[type="checkbox"]:checked::before {
            color: #ffffff;
        }
        body.light-mode .slider {
            background-color: #a0a0a0;
        }
        body.light-mode input:checked + .slider {
            background-color: #007bff;
        }
        body.light-mode button {
            background-color: #007bff;
            color: white;
        }
        body.light-mode button:hover {
            background-color: #0056b3;
        }
        body.light-mode .nav-buttons a {
            background-color: #007bff;
            color: white;
        }
        body.light-mode .nav-buttons a:hover {
            background-color: #0056b3;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin-bottom: 20px;
        }
        .logo {
            position: absolute;
            left: 0;
            height: 50px;
            cursor: pointer;
            content: url('https://placehold.co/50x50/2ba8b8/0f1928?text=TF'); /* Adjusted for light mode */
            border-radius: 5px;
        }
        body.light-mode .logo {
            content: url('https://placehold.co/50x50/007bff/e0e0e0?text=TF');
        }
        h1 {
            font-size: 2em;
            color: #2ba8b8;
        }
        h2 {
            color: #2ba8b8;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            background: #162c3b;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 30px;
        }
        .section-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 20px;
            margin-bottom: 10px;
            color: #229fc1;
            transition: border-bottom 0.3s ease;
            display: inline-block;
            cursor: pointer;
        }
        .section-title:hover {
            border-bottom: 2px solid #229fc1;
        }
        ul {
            line-height: 1.8;
            padding-left: 0; /* Changed to 0 for better alignment with flex items */
            list-style: none;
        }
        ul li {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            max-width: 1000px;
            margin: 40px auto;
        }
        .nav-buttons a {
            background-color: #2ba8b8;
            color: #0f1928;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .nav-buttons a:hover {
            background-color: #1d7c88;
        }

        /* Specific styles for settings page elements */
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #1f394f;
        }
        .setting-item:last-child {
            border-bottom: none;
        }
        .setting-label {
            flex-grow: 1;
            padding-right: 15px;
        }
        .setting-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        input[type="number"], input[type="text"], input[type="password"] {
            background: #0f1928;
            border: 1px solid #229fc1;
            border-radius: 5px;
            padding: 8px 10px;
            color: white;
            width: 80px;
            text-align: center;
        }
        input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #229fc1;
            border-radius: 4px;
            position: relative;
            cursor: pointer;
            outline: none;
        }
        input[type="checkbox"]:checked {
            background-color: #2ba8b8;
            border-color: #2ba8b8;
        }
        input[type="checkbox"]:checked::before {
            content: '‚úî';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
            color: #0f1928;
        }
        button {
            background-color: #2ba8b8;
            color: #0f1928;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #1d7c88;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2ba8b8;
        }
        input:focus + .slider {
            box-shadow: 0 0 1px #2ba8b8;
        }
        input:checked + .slider:before {
            -webkit-transform: translateX(16px);
            -ms-transform: translateX(16px);
            transform: translateX(16px);
        }

        /* Message Box / Modal Styles */
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.3s ease-in-out;
        }
        .message-box-overlay.visible {
            visibility: visible;
            opacity: 1;
        }
        .message-box {
            background: #162c3b;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
            color: white;
            position: relative; /* Needed for close button positioning */
        }
        .message-box h4 {
            margin-top: 0;
            color: #2ba8b8;
        }
        .message-box p {
            margin-bottom: 20px;
        }
        .message-box-buttons button {
            margin: 0 10px;
        }
        .message-box-content-area {
            text-align: left;
            margin-bottom: 20px;
        }
        .message-box-content-area label {
            display: block;
            margin-bottom: 5px;
            color: #229fc1;
        }
        .message-box-content-area input[type="password"] {
            width: calc(100% - 20px); /* Adjust width for padding */
            padding: 8px 10px;
            margin-bottom: 15px;
            background: #0f1928;
            border: 1px solid #229fc1;
            border-radius: 5px;
            color: white;
        }
        .message-box-content-area .error-message {
            color: #e74c3c;
            font-size: 0.9em;
            margin-top: -10px;
            margin-bottom: 10px;
        }
        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
        }
        .close-button:hover {
            color: #2ba8b8;
        }
    </style>
</head>
<body>
    <header>
        <img src="https://placehold.co/50x50/2ba8b8/0f1928?text=TF" alt="Track Fit Logo" class="logo" onerror="this.onerror=null; this.src='https://placehold.co/50x50/2ba8b8/0f1928?text=TF';">
        <h1>Track Fit</h1>
    </header>

    <h2>‚öôÔ∏è Settings</h2>

    <!-- Goal Settings Section -->
    <div class="section">
        <h3 class="section-title">üéØ Goal Settings</h3>
        <ul>
            <li class="setting-item">
                <span class="setting-label">Daily Steps Goal</span>
                <div class="setting-control">
                    <input type="number" id="dailyStepsGoal" value="10000" min="0">
                    <span>steps</span>
                </div>
            </li>
            <li class="setting-item">
                <span class="setting-label">Calorie Goal</span>
                <div class="setting-control">
                    <input type="number" id="calorieGoal" value="2000" min="0">
                    <span>kcal</span>
                </div>
            </li>
            <li class="setting-item">
                <span class="setting-label">Workout Minutes Goal</span>
                <div class="setting-control">
                    <input type="number" id="workoutMinutesGoal" value="30" min="0">
                    <span>minutes</span>
                </div>
            </li>
            <li class="setting-item">
                <span class="setting-label">Water Intake Target</span>
                <div class="setting-control">
                    <input type="number" id="waterIntakeTarget" value="2.5" min="0" step="0.1">
                    <span>liters</span>
                </div>
            </li>
            <li class="setting-item">
                <span class="setting-label">Sleep Hour Goal</span>
                <div class="setting-control">
                    <input type="number" id="sleepHourGoal" value="8" min="0" step="0.5">
                    <span>hours</span>
                </div>
            </li>
        </ul>
    </div>

    <!-- Reminders Section -->
    <div class="section">
        <h3 class="section-title">üîî Reminders</h3>
        <ul>
            <li class="setting-item">
                <span class="setting-label">Meal Time Reminder</span>
                <div class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="mealTimeReminder" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </li>
            <li class="setting-item">
                <span class="setting-label">Workout Reminder</span>
                <div class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="workoutReminder" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </li>
            <li class="setting-item">
                <span class="setting-label">Water Intake Reminder</span>
                <div class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="waterIntakeReminder" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </li>
            <li class="setting-item">
                <span class="setting-label">Sleep Time Reminder</span>
                <div class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="sleepTimeReminder">
                        <span class="slider"></span>
                    </label>
                </div>
            </li>
            <li class="setting-item">
                <span class="setting-label">Weekly Check-In Reminder</span>
                <div class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="weeklyCheckInReminder" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </li>
        </ul>
    </div>

    <!-- Theme Mode Section -->
    <div class="section">
        <h3 class="section-title">üåô Theme Mode</h3>
        <ul>
            <li class="setting-item">
                <span class="setting-label">Dark Mode / Light Mode</span>
                <div class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="themeModeToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </li>
        </ul>
    </div>

    <!-- Data Sync Section -->
    <div class="section">
        <h3 class="section-title">üîÑ Data Sync</h3>
        <ul>
            <li class="setting-item">
                <span class="setting-label">Sync with Apple Health / Google Fit</span>
                <div class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="syncHealthFit">
                        <span class="slider"></span>
                    </label>
                </div>
            </li>
            <li class="setting-item">
                <span class="setting-label">Enable Auto-Sync</span>
                <div class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="enableAutoSync" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </li>
            <li class="setting-item">
                <span class="setting-label">Manual Sync</span>
                <div class="setting-control">
                    <button id="manualSyncButton">Sync Now</button>
                </div>
            </li>
        </ul>
    </div>

    <!-- Data Management Section -->
    <div class="section">
        <h3 class="section-title">üì¶ Data Management</h3>
        <ul>
            <li class="setting-item">
                <span class="setting-label">Export Data</span>
                <div class="setting-control">
                    <button id="exportCsvButton">Export (CSV)</button>
                    <button id="exportExcelButton">Export (JSON)</button> <!-- Changed to JSON for simplicity -->
                </div>
            </li>
            <li class="setting-item">
                <span class="setting-label">Reset All Data</span>
                <div class="setting-control">
                    <button id="resetAllDataButton" style="background-color: #e74c3c;">Reset</button>
                </div>
            </li>
            <li class="setting-item">
                <span class="setting-label">Backup/Restore Progress</span>
                <div class="setting-control">
                    <button id="backupButton">Backup</button>
                    <button id="restoreButton">Restore</button>
                </div>
            </li>
        </ul>
    </div>

    <!-- Security Section -->
    <div class="section">
        <h3 class="section-title">üîí Security</h3>
        <ul>
            <li class="setting-item">
                <span class="setting-label">Biometric Login (Face ID / Fingerprint)</span>
                <div class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="biometricLogin">
                        <span class="slider"></span>
                    </label>
                </div>
            </li>
            <li class="setting-item">
                <span class="setting-label">Change Password</span>
                <div class="setting-control">
                    <button id="changePasswordButton">Change</button>
                </div>
            </li>
            <li class="setting-item">
                <span class="setting-label">Logout</span>
                <div class="setting-control">
                    <button id="logoutButton" style="background-color: #e74c3c;">Logout</button>
                </div>
            </li>
        </ul>
    </div>

    <!-- Notification Settings Section -->
    <div class="section">
        <h3 class="section-title">üì± Notification Settings</h3>
        <ul>
            <li class="setting-item">
                <span class="setting-label">Enable All Notifications</span>
                <div class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="enableAllNotifications" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </li>
            <li class="setting-item">
                <span class="setting-label">Notification Sound</span>
                <div class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="notificationSound" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </li>
            <li class="setting-item">
                <span class="setting-label">Notification Vibration</span>
                <div class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="notificationVibration" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </li>
        </ul>
    </div>

    <div class="nav-buttons">
        <a href="#" id="backToTipsButton">Back to Tips</a>
        <a href="#" id="saveSettingsButton">Save Settings</a>
    </div>

    <!-- Custom Message Box/Modal -->
    <div class="message-box-overlay" id="messageBoxOverlay">
        <div class="message-box">
            <button class="close-button" id="messageBoxCloseButton">&times;</button>
            <h4 id="messageBoxTitle"></h4>
            <p id="messageBoxContent"></p>
            <div class="message-box-content-area" id="messageBoxCustomContent">
                <!-- Custom content for forms will be injected here -->
            </div>
            <div class="message-box-buttons">
                <button id="messageBoxConfirmButton" style="display: none;">Confirm</button>
                <button id="messageBoxCancelButton" style="display: none;">Cancel</button>
                <button id="messageBoxOkButton" style="display: none;">OK</button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const dailyStepsGoal = document.getElementById('dailyStepsGoal');
        const calorieGoal = document.getElementById('calorieGoal');
        const workoutMinutesGoal = document.getElementById('workoutMinutesGoal');
        const waterIntakeTarget = document.getElementById('waterIntakeTarget');
        const sleepHourGoal = document.getElementById('sleepHourGoal');

        const mealTimeReminder = document.getElementById('mealTimeReminder');
        const workoutReminder = document.getElementById('workoutReminder');
        const waterIntakeReminder = document.getElementById('waterIntakeReminder');
        const sleepTimeReminder = document.getElementById('sleepTimeReminder');
        const weeklyCheckInReminder = document.getElementById('weeklyCheckInReminder');

        const themeModeToggle = document.getElementById('themeModeToggle');

        const syncHealthFit = document.getElementById('syncHealthFit');
        const enableAutoSync = document.getElementById('enableAutoSync');
        const manualSyncButton = document.getElementById('manualSyncButton');

        const exportCsvButton = document.getElementById('exportCsvButton');
        const exportExcelButton = document.getElementById('exportExcelButton');
        const resetAllDataButton = document.getElementById('resetAllDataButton');
        const backupButton = document.getElementById('backupButton');
        const restoreButton = document.getElementById('restoreButton');

        const biometricLogin = document.getElementById('biometricLogin');
        const changePasswordButton = document.getElementById('changePasswordButton');
        const logoutButton = document.getElementById('logoutButton');

        const enableAllNotifications = document.getElementById('enableAllNotifications');
        const notificationSound = document.getElementById('notificationSound');
        const notificationVibration = document.getElementById('notificationVibration');

        const saveSettingsButton = document.getElementById('saveSettingsButton');
        const backToTipsButton = document.getElementById('backToTipsButton');

        // Message Box elements
        const messageBoxOverlay = document.getElementById('messageBoxOverlay');
        const messageBoxCloseButton = document.getElementById('messageBoxCloseButton'); // New close button
        const messageBoxTitle = document.getElementById('messageBoxTitle');
        const messageBoxContent = document.getElementById('messageBoxContent');
        const messageBoxCustomContent = document.getElementById('messageBoxCustomContent'); // New custom content area

        // Changed from const to let to allow reassignment after cloning
        let messageBoxConfirmButton = document.getElementById('messageBoxConfirmButton');
        let messageBoxCancelButton = document.getElementById('messageBoxCancelButton');
        let messageBoxOkButton = document.getElementById('messageBoxOkButton');

        const SETTINGS_STORAGE_KEY = 'trackFitSettings';
        const BACKUP_STORAGE_KEY = 'trackFitSettingsBackup';
        const THEME_STORAGE_KEY = 'trackFitTheme';

        /**
         * Displays a custom message box (modal).
         * @param {string} title - The title of the message box.
         * @param {string} content - The main content/message.
         * @param {string} type - 'alert' (OK button) or 'confirm' (Confirm/Cancel buttons) or 'custom' (for forms).
         * @param {string} [customHtml=''] - Optional HTML content to inject for 'custom' type.
         * @returns {Promise<boolean>} - Resolves true for 'Confirm'/'OK', false for 'Cancel'.
         */
        function showMessageBox(title, content, type, customHtml = '') {
            return new Promise((resolve) => {
                messageBoxTitle.textContent = title;
                messageBoxContent.textContent = content;
                messageBoxCustomContent.innerHTML = customHtml; // Inject custom HTML

                // Reset button visibility
                messageBoxConfirmButton.style.display = 'none';
                messageBoxCancelButton.style.display = 'none';
                messageBoxOkButton.style.display = 'none';
                messageBoxContent.style.display = 'block'; // Ensure content p is visible by default
                messageBoxCustomContent.style.display = 'none'; // Hide custom content by default

                if (type === 'custom') {
                    messageBoxContent.style.display = 'none'; // Hide default content for custom forms
                    messageBoxCustomContent.style.display = 'block'; // Show custom content area
                }

                // Clear previous listeners to prevent duplicates and re-attach them to new cloned elements
                const cloneAndReplace = (oldElement) => {
                    const newElement = oldElement.cloneNode(true);
                    oldElement.parentNode.replaceChild(newElement, oldElement);
                    return newElement;
                };

                messageBoxConfirmButton = cloneAndReplace(messageBoxConfirmButton);
                messageBoxCancelButton = cloneAndReplace(messageBoxCancelButton);
                messageBoxOkButton = cloneAndReplace(messageBoxOkButton);


                // Add close button functionality
                messageBoxCloseButton.onclick = () => {
                    messageBoxOverlay.classList.remove('visible');
                    resolve(false); // Treat close as a cancellation for prompts
                };

                if (type === 'confirm' || type === 'custom') { // Custom also typically needs a confirm/cancel
                    messageBoxConfirmButton.style.display = 'inline-block';
                    messageBoxCancelButton.style.display = 'inline-block';

                    messageBoxConfirmButton.addEventListener('click', () => {
                        messageBoxOverlay.classList.remove('visible');
                        resolve(true);
                    });
                    messageBoxCancelButton.addEventListener('click', () => {
                        messageBoxOverlay.classList.remove('visible');
                        resolve(false);
                    });

                } else { // type === 'alert'
                    messageBoxOkButton.style.display = 'inline-block';

                    messageBoxOkButton.addEventListener('click', () => {
                        messageBoxOverlay.classList.remove('visible');
                        resolve(true); // Always resolve true for alert
                    });
                }

                messageBoxOverlay.classList.add('visible');
            });
        }

        /**
         * Gathers all current settings from the DOM and returns them as an object.
         * @returns {object} - An object containing all current settings.
         */
        function getCurrentSettings() {
            return {
                goals: {
                    dailySteps: parseInt(dailyStepsGoal.value, 10),
                    calorie: parseInt(calorieGoal.value, 10),
                    workoutMinutes: parseInt(workoutMinutesGoal.value, 10),
                    waterIntake: parseFloat(waterIntakeTarget.value),
                    sleepHour: parseFloat(sleepHourGoal.value)
                },
                reminders: {
                    mealTime: mealTimeReminder.checked,
                    workout: workoutReminder.checked,
                    waterIntake: waterIntakeReminder.checked,
                    sleepTime: sleepTimeReminder.checked,
                    weeklyCheckIn: weeklyCheckInReminder.checked
                },
                dataSync: {
                    syncHealthFit: syncHealthFit.checked,
                    enableAutoSync: enableAutoSync.checked
                },
                security: {
                    biometricLogin: biometricLogin.checked
                },
                notifications: {
                    enableAll: enableAllNotifications.checked,
                    sound: notificationSound.checked,
                    vibration: notificationVibration.checked
                }
            };
        }

        /**
         * Performs the actual saving of settings to localStorage.
         * This function will be called after user confirmation.
         */
        function performActualSave() {
            const settings = getCurrentSettings();
            try {
                localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(settings));
                showMessageBox('Settings Saved', 'Your settings have been saved successfully!', 'alert');
            } catch (e) {
                console.error('Error saving settings to localStorage:', e);
                showMessageBox('Error', 'Failed to save settings. Please try again.', 'alert');
            }
        }

        /**
         * Loads settings from localStorage and applies them to the DOM.
         */
        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem(SETTINGS_STORAGE_KEY);
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);

                    // Load Goal Settings
                    dailyStepsGoal.value = settings.goals.dailySteps || 10000;
                    calorieGoal.value = settings.goals.calorie || 2000;
                    workoutMinutesGoal.value = settings.goals.workoutMinutes || 30;
                    waterIntakeTarget.value = settings.goals.waterIntake || 2.5;
                    sleepHourGoal.value = settings.goals.sleepHour || 8;

                    // Load Reminders
                    mealTimeReminder.checked = settings.reminders.mealTime !== undefined ? settings.reminders.mealTime : true;
                    workoutReminder.checked = settings.reminders.workout !== undefined ? settings.reminders.workout : true;
                    waterIntakeReminder.checked = settings.reminders.waterIntake !== undefined ? settings.reminders.waterIntake : true;
                    sleepTimeReminder.checked = settings.reminders.sleepTime !== undefined ? settings.reminders.sleepTime : false;
                    weeklyCheckInReminder.checked = settings.reminders.weeklyCheckIn !== undefined ? settings.reminders.weeklyCheckIn : true;

                    // Load Data Sync
                    syncHealthFit.checked = settings.dataSync.syncHealthFit !== undefined ? settings.dataSync.syncHealthFit : false;
                    enableAutoSync.checked = settings.dataSync.enableAutoSync !== undefined ? settings.dataSync.enableAutoSync : true;

                    // Load Security
                    biometricLogin.checked = settings.security.biometricLogin !== undefined ? settings.security.biometricLogin : false;

                    // Load Notifications
                    enableAllNotifications.checked = settings.notifications.enableAll !== undefined ? settings.notifications.enableAll : true;
                    notificationSound.checked = settings.notifications.sound !== undefined ? settings.notifications.sound : true;
                    notificationVibration.checked = settings.notifications.vibration !== undefined ? settings.notifications.vibration : true;
                }
            } catch (e) {
                console.error('Error loading settings from localStorage:', e);
                // Fallback to default values if loading fails
            }
        }

        /**
         * Toggles the theme between dark and light mode.
         */
        function toggleTheme() {
            const isLightMode = themeModeToggle.checked;
            if (isLightMode) {
                document.body.classList.add('light-mode');
                localStorage.setItem(THEME_STORAGE_KEY, 'light');
            } else {
                document.body.classList.remove('light-mode');
                localStorage.setItem(THEME_STORAGE_KEY, 'dark');
            }
            // Update logo based on theme
            const logo = document.querySelector('.logo');
            if (logo) {
                logo.src = isLightMode ? 'https://placehold.co/50x50/007bff/e0e0e0?text=TF' : 'https://placehold.co/50x50/2ba8b8/0f1928?text=TF';
            }
        }

        /**
         * Loads the theme from localStorage on page load.
         */
        function loadTheme() {
            const savedTheme = localStorage.getItem(THEME_STORAGE_KEY);
            if (savedTheme === 'light') {
                themeModeToggle.checked = true; // Set toggle to light
            } else {
                themeModeToggle.checked = false; // Set toggle to dark
            }
            toggleTheme(); // Apply the loaded theme
        }

        /**
         * Handles the manual sync button click.
         */
        manualSyncButton.addEventListener('click', () => {
            showMessageBox('Syncing Data', 'Attempting to sync your data. This may take a moment...', 'alert');
            // In a real application, actual data synchronization logic would go here,
            // potentially with a loading spinner and success/failure message.
            setTimeout(() => {
                showMessageBox('Sync Complete', 'Your data has been synced successfully!', 'alert');
            }, 1500); // Simulate network delay
        });

        /**
         * Handles exporting data.
         * @param {string} format - 'csv' or 'json'
         */
        function exportData(format) {
            const settings = getCurrentSettings();
            let dataString = '';
            let filename = `track_fit_settings.${format}`;
            let mimeType = '';

            if (format === 'json') {
                dataString = JSON.stringify(settings, null, 2);
                mimeType = 'application/json';
            } else if (format === 'csv') {
                // Simplified CSV export: just goal settings for demonstration
                const headers = Object.keys(settings.goals).join(',');
                const values = Object.values(settings.goals).join(',');
                dataString = `${headers}\n${values}`;
                mimeType = 'text/csv';
            }

            const blob = new Blob([dataString], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessageBox('Export Complete', `Your settings have been exported as ${filename}!`, 'alert');
        }

        exportCsvButton.addEventListener('click', () => exportData('csv'));
        exportExcelButton.addEventListener('click', () => exportData('json')); // Export as JSON for Excel compatibility

        /**
         * Handles resetting all data.
         */
        resetAllDataButton.addEventListener('click', async () => {
            const confirmed = await showMessageBox(
                'Confirm Reset',
                'Are you sure you want to reset ALL your data? This action cannot be undone.',
                'confirm'
            );
            if (confirmed) {
                localStorage.removeItem(SETTINGS_STORAGE_KEY);
                localStorage.removeItem(BACKUP_STORAGE_KEY);
                localStorage.removeItem(THEME_STORAGE_KEY); // Also reset theme
                loadSettings(); // Reload defaults
                loadTheme(); // Reload default theme
                showMessageBox('Data Reset', 'All your Track Fit data has been reset.', 'alert');
            }
        });

        /**
         * Handles backing up settings.
         */
        backupButton.addEventListener('click', () => {
            const settings = getCurrentSettings();
            try {
                localStorage.setItem(BACKUP_STORAGE_KEY, JSON.stringify(settings));
                showMessageBox('Backup Complete', 'Your current settings have been backed up.', 'alert');
            } catch (e) {
                console.error('Error backing up settings:', e);
                showMessageBox('Backup Failed', 'Could not backup settings. Please try again.', 'alert');
            }
        });

        /**
         * Handles restoring settings from backup.
         */
        restoreButton.addEventListener('click', async () => {
            const backupExists = localStorage.getItem(BACKUP_STORAGE_KEY);
            if (!backupExists) {
                showMessageBox('No Backup Found', 'No backup data found to restore from.', 'alert');
                return;
            }

            const confirmed = await showMessageBox(
                'Confirm Restore',
                'Are you sure you want to restore from backup? This will overwrite your current settings.',
                'confirm'
            );
            if (confirmed) {
                try {
                    const backedUpSettings = JSON.parse(backupExists);
                    localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(backedUpSettings));
                    loadSettings(); // Apply restored settings to UI
                    // Force theme reload if it was part of the backup, otherwise keep current.
                    // For now, let's keep theme separate or explicitly save/load it too.
                    showMessageBox('Restore Complete', 'Your settings have been restored from backup.', 'alert');
                } catch (e) {
                    console.error('Error restoring settings:', e);
                    showMessageBox('Restore Failed', 'Could not restore settings. Backup might be corrupted.', 'alert');
                }
            }
        });

        /**
         * Handles the change password interaction.
         */
        changePasswordButton.addEventListener('click', async () => {
            const passwordFormHtml = `
                <div class="password-form">
                    <label for="currentPassword">Current Password:</label>
                    <input type="password" id="currentPassword" placeholder="Enter current password">
                    <label for="newPassword">New Password:</label>
                    <input type="password" id="newPassword" placeholder="Enter new password">
                    <label for="confirmNewPassword">Confirm New Password:</label>
                    <input type="password" id="confirmNewPassword" placeholder="Confirm new password">
                    <p id="passwordError" class="error-message" style="display: none;"></p>
                </div>
            `;

            const confirmed = await showMessageBox(
                'Change Password',
                'Please enter your current and new password:',
                'custom',
                passwordFormHtml
            );

            if (confirmed) {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmNewPassword = document.getElementById('confirmNewPassword').value;
                const passwordError = document.getElementById('passwordError');

                // Basic validation
                if (!currentPassword || !newPassword || !confirmNewPassword) {
                    passwordError.textContent = 'All fields are required.';
                    passwordError.style.display = 'block';
                    // Re-open the modal with error (simulated re-display for validation)
                    await showMessageBox(
                        'Change Password',
                        'All fields are required. Please try again:',
                        'custom',
                        passwordFormHtml
                    );
                    return; // Stop further execution
                }

                if (newPassword !== confirmNewPassword) {
                    passwordError.textContent = 'New passwords do not match.';
                    passwordError.style.display = 'block';
                     // Re-open the modal with error (simulated re-display for validation)
                    await showMessageBox(
                        'Change Password',
                        'New passwords do not match. Please try again:',
                        'custom',
                        passwordFormHtml
                    );
                    return; // Stop further execution
                }

                // In a real application, you would send these to a backend for verification and update.
                // For this simulation, we'll just show a success message.
                showMessageBox('Password Changed', 'Your password has been changed successfully!', 'alert');
            } else {
                showMessageBox('Password Change Cancelled', 'Password change operation was cancelled.', 'alert');
            }
        });

        /**
         * Handles the logout interaction.
         */
        logoutButton.addEventListener('click', async () => {
            const confirmed = await showMessageBox(
                'Confirm Logout',
                'Are you sure you want to log out of Track Fit?',
                'confirm'
            );
            if (confirmed) {
                showMessageBox('Logging Out', 'You are being logged out...', 'alert');
                setTimeout(() => {
                    localStorage.clear(); // Clear all app data for a full logout simulation
                    // Redirect to the new login.html page
                    window.location.href = 'login.html';
                }, 1000); // Simulate logout process
            } else {
                showMessageBox('Logout Cancelled', 'You have decided not to log out.', 'alert');
            }
        });

        // Event listener for theme toggle
        themeModeToggle.addEventListener('change', toggleTheme);

        // Event listener for the main "Save Settings" button
        saveSettingsButton.addEventListener('click', async () => {
            const confirmed = await showMessageBox(
                'Confirm Save',
                'Do you want to save your current settings?',
                'confirm'
            );
            if (confirmed) {
                performActualSave(); // Call the actual saving logic only if confirmed
            } else {
                showMessageBox('Save Cancelled', 'Settings were not saved.', 'alert');
            }
        });

        // Placeholder for back to tips button
        backToTipsButton.addEventListener('click', (e) => {
            e.preventDefault(); // Prevent default link behavior
            showMessageBox('Navigation', 'Navigating back to workout tips...', 'alert');
            // In a real app, this would navigate to the tips page.
        });


        // Initialize settings and theme on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme(); // Load theme first
            loadSettings(); // Then load other settings
        });

        // REMOVED: Automatic saving on input changes. Saving is now exclusively via "Save Settings" button.
        // const allInputs = document.querySelectorAll('input[type="number"], input[type="checkbox"]');
        // allInputs.forEach(input => {
        //     input.addEventListener('change', saveSettings);
        // });
    </script>
</body>
</html>
